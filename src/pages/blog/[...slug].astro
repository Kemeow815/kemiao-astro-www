---
import { type CollectionEntry, getCollection } from "astro:content";
import FloatBtn from "@/components/fab/FloatActionBtn.astro";
import { PostActions } from "@/components/post/PostActions";
import { PostSummary } from "@/components/post/PostSummary";
import BaseLayout from "@/layouts/BaseLayout.astro";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  return posts
    .map((post) => ({
      params: { slug: post.slug },
      props: post,
    }))
    .flat();
}
type Props = CollectionEntry<"blog">;

const post = Astro.props;
const { Content, headings } = await post.render();
const { title, tldr, date, tags = [], cover } = post.data;
---

<BaseLayout title={title} description={tldr} ogImage={cover}>
  {date && <meta name="date" content={date.toLocaleDateString()} slot="head" />}

  <main
    class="mx-auto py-8 prose dark:prose-invert prose-img:rounded-md prose-a:font-medium prose-a:text-black prose-a:no-underline prose-a:border-b-2 prose-a:border-black dark:prose-a:text-white dark:prose-a:border-white prose-p:text-justify"
  >
    <article>
      <h1>{title}</h1>
      <PostSummary date={date} tags={tags} client:load />
      <section id="content">
        <Content />
      </section>
    </article>
    <hr />
    <section class="mt-4 text-sm leading-loose text-gray-600 dark:text-zinc-400">
      商业转载请联系站长获得授权，非商业转载请注明本文出处及文章链接，您可以自由地在任何媒体以任何形式复制和分发作品，也可以修改和创作，但是分发衍生作品时必须采用相同的许可协议。<br
      />
      本文采用<a target="_blank" rel="noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"
        >CC BY-NC-SA 4.0 - 非商业性使用 - 相同方式共享 4.0
      </a>国际进行许可。
    </section>
  </main>
  <PostActions headings={headings} client:load />

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
  <script is:inline>
    let spreaded = false;
    window.addEventListener("scroll", () => {
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      const scrollHeight = document.documentElement.scrollHeight;
      const clientHeight = document.documentElement.clientHeight;
      const scrollPercentage = (scrollTop / (scrollHeight - clientHeight)) * 100;
      if (scrollPercentage >= 99 && !spreaded) {
        confetti({
          particleCount: 100,
          spread: 70,
          origin: { y: 0.6 },
        });
        spreaded = true;
      }
    });
  </script>
</BaseLayout>
