---
import Emoji from './Emoji.astro';
---

<div class="fixed bottom-8 right-6 flex flex-col gap-4" aria-label="floating button">
  <button
    class="flex items-center justify-center size-12 text-lg md:size-10 md:text-base outline-accent hover:opacity-100 focus:opacity-100 focus:outline-none rounded-xl border border-zinc-400/20 backdrop-blur-lg dark:border-zinc-500/30 dark:text-zinc-200 bg-zinc-50/80 shadow-lg dark:bg-slate-950/80 transition-all duration-500 ease-in-out"
    id="search-btn"
    title="搜一搜"
  >
    <Emoji class:list="text-sm">🔍</Emoji>
  </button>
  <button
    class="flex items-center justify-center size-12 text-lg md:size-10 md:text-base outline-accent hover:opacity-100 focus:opacity-100 focus:outline-none rounded-xl border border-zinc-400/20 backdrop-blur-lg dark:border-zinc-500/30 dark:text-zinc-200 bg-zinc-50/80 shadow-lg dark:bg-slate-950/80 transition-all duration-500 ease-in-out"
    id="ai-btn"
    title="复制 Prompt"
  >
    <Emoji class:list="text-sm">🤖</Emoji>
  </button>
</div>

<div class="hidden" id="search-box">
  <div
    id="search-backdrop"
    class="fixed z-[1000] left-0 top-0 backdrop-blur-[2px] h-screen w-screen overflow-hidden flex justify-center items-center"
  >
  </div>
  <div
    class="fixed left-1/2 top-32 -translate-x-1/2 z-[1001] max-sm:w-11/12 w-[560px] bg-blue-50 rounded-lg overflow-hidden shadow-xl dark:bg-slate-900"
  >
    <div class="p-4">
      <input
        id="search-input"
        class="w-full p-2 border-2 border-blue-500 rounded-lg focus:ring-0 focus:border-blue-500 outline-none dark:bg-slate-950"
        type="text"
        placeholder="搜索 coderfee.com"
      />
    </div>

    <div id="results" class="min-h-52 max-h-96 p-4 pt-0 overflow-auto space-y-2">
      <div class="w-full min-h-48 text-5xl text-center flex justify-center items-center select-none">
        <div>🤔🔍</div>
      </div>
    </div>
  </div>
</div>

<script type="module">
  const pagefind = await import('/pagefind/pagefind.js');
  pagefind.init();
  const resultEl = document.querySelector('#results');
  const searchInput = document.querySelector('#search-input');
  const searchIcon = document.querySelector('#search-btn');
  const searchBackdrop = document.querySelector('#search-backdrop');

  searchIcon.addEventListener('click', () => {
    toggleSearchBox();
  });
  searchBackdrop.addEventListener('click', () => {
    toggleSearchBox();
  });

  searchInput.addEventListener('input', handleSearch);

  function toggleSearchBox() {
    const searchBox = document.querySelector('#search-box');
    searchBox.classList.toggle('hidden');
    if (!searchBox.classList.contains('hidden')) {
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = 'auto';
    }
  }
  async function handleSearch(e) {
    const { value } = e.target;
    let html = '';
    const search = await pagefind.search(value);
    const results = search.results.map((item) => item.data());
    const data = await Promise.all(results);
    data.map(({ meta: { title }, url, excerpt }) => {
      html += `
      <div class="bg-white dark:bg-slate-800 p-2 rounded-lg shadow-xl">
        <a href="${url}" class="text-blue-500 hover:text-blue-600 transition-colors duration-200">${title}</a>
        <p class="text-gray-500 text-sm line-clamp-1 text-ellipsis mt-1 ml-4">${excerpt.replaceAll('<mark', '<mark class="bg-blue-500 text-white"')}</p>
      </div>
    `;
    });
    resultEl.innerHTML =
      data.length > 0
        ? html
        : '<div class="w-full min-h-48 text-5xl text-center flex justify-center items-center select-none"><div>🤔🔍</div></div>';
  }
</script>

<script>
  const prompt = `
    '''
    【📚 文章助手】你是一个文章阅读助手，你具有以下能力：
    1. 快速阅读并总结文章大意，提炼核心观点；
    2. 分析作者的论据和逻辑，为用户提供深入的思考角度；
    3. 准确抓取并展示文章中的关键数据；
    4. 批判性思考，检查文章的逻辑性和一致性。
    5. 提出问题，引发读者思考
    按照以上格式进行输出
    '''
    想要阅读的链接是：{}
  `;
  const aiBtn = document.querySelector('#ai-btn');
  aiBtn?.addEventListener('click', () => {
    const fullPrompt = prompt.replace('{}', window.location.href);
    copyTextToClipboard(fullPrompt);
  });

  function copyTextToClipboard(text) {
    if (!navigator.clipboard) {
      fallbackCopyTextToClipboard(text);
      return;
    }

    navigator.clipboard.writeText(text).then(
      function () {
        console.log('复制成功');
      },
      function (err) {
        console.error('无法复制文字到剪贴板:', err);
      },
    );
  }

  function fallbackCopyTextToClipboard(text) {
    var textarea = document.createElement('textarea');
    textarea.value = text;
    document.body.appendChild(textarea);
    textarea.select();

    try {
      var successful = document.execCommand('copy');
      var msg = successful ? '复制成功' : '无法复制文字到剪贴板，请手动复制。';
      console.log(msg);
    } catch (err) {
      console.error('无法执行拷贝命令:', err);
    }

    document.body.removeChild(textarea);
  }
</script>
